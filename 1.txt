using LabUI.Models;
using Microsoft.AspNetCore.Http;

namespace LabUI.Services
{
    public class MemoryProductService : IProductService
    {
        private List<Dish> _dishes;
        private List<Category> _categories;

        public MemoryProductService(ICategoryService categoryService)
        {
            var categoryResponse = categoryService.GetCategoryListAsync().Result;
            _categories = categoryResponse.Data ?? new List<Category>();
            SetupData();
        }

        private void SetupData()
        {
            _dishes = new List<Dish>
            {
                new Dish 
                { 
                    Id = 1, 
                    Name = "Суп-харчо", 
                    Description = "Очень острый, невкусный", 
                    Calories = 200, 
                    Image = "Images/soup.jpg",  
                    CategoryId = _categories.Find(c => c.NormalizedName == "starters")?.Id ?? 1
                },
                new Dish 
                { 
                    Id = 2, 
                    Name = "Борщ", 
                    Description = "Много сала, без сметаны", 
                    Calories = 330, 
                    Image = "Images/borshch.jpg", 
                    CategoryId = _categories.Find(c => c.NormalizedName == "starters")?.Id ?? 1
                },
                new Dish 
                { 
                    Id = 3, 
                    Name = "Цезарь", 
                    Description = "С курицей и пармезаном", 
                    Calories = 180, 
                    Image = "Images/caesar.jpg", 
                    CategoryId = _categories.Find(c => c.NormalizedName == "salads")?.Id ?? 2
                },
                new Dish 
                { 
                    Id = 4, 
                    Name = "Стейк", 
                    Description = "Говяжий стейк средней прожарки", 
                    Calories = 450, 
                    Image = "Images/steak.jpg", 
                    CategoryId = _categories.Find(c => c.NormalizedName == "main-courses")?.Id ?? 3
                },
                new Dish 
                { 
                    Id = 5, 
                    Name = "Тирамису", 
                    Description = "Итальянский десерт", 
                    Calories = 320, 
                    Image = "Images/tiramisu.jpg", 
                    CategoryId = _categories.Find(c => c.NormalizedName == "desserts")?.Id ?? 4
                },
                new Dish 
                { 
                    Id = 6, 
                    Name = "Кофе", 
                    Description = "Свежесваренный арабика", 
                    Calories = 5, 
                    Image = "Images/coffee.jpg", 
                    CategoryId = _categories.Find(c => c.NormalizedName == "drinks")?.Id ?? 5
                }
            };
        }

        public Task<ResponseData<ListModel<Dish>>> GetProductListAsync(string? categoryNormalizedName, int pageNo = 1)
        {
            int? categoryId = null;

            if (categoryNormalizedName != null)
            {
                categoryId = _categories.Find(c => c.NormalizedName.Equals(categoryNormalizedName))?.Id;
            }

            var data = _dishes.Where(d => categoryId == null || d.CategoryId.Equals(categoryId)).ToList();

            var model = new ListModel<Dish>
            {
                Items = data,
                CurrentPage = pageNo,
                TotalPages = 1,
                TotalCount = data.Count
            };

            var result = new ResponseData<ListModel<Dish>>
            {
                Data = model
            };

            if (data.Count == 0)
            {
                result.Success = false;
                result.ErrorMessage = "Нет объектов в выбранной категории";
            }

            return Task.FromResult(result);
        }

        public Task<ResponseData<Dish>> GetProductByIdAsync(int id)
        {
            var dish = _dishes.FirstOrDefault(d => d.Id == id);
            var result = new ResponseData<Dish>
            {
                Data = dish,
                Success = dish != null,
                ErrorMessage = dish == null ? "Блюдо не найдено" : null
            };

            return Task.FromResult(result);
        }

        public Task UpdateProductAsync(int id, Dish product, IFormFile? formFile)
        {
            var existingDish = _dishes.FirstOrDefault(d => d.Id == id);
            if (existingDish != null)
            {
                existingDish.Name = product.Name;
                existingDish.Description = product.Description;
                existingDish.Calories = product.Calories;
                existingDish.CategoryId = product.CategoryId;
            }
            return Task.CompletedTask;
        }

        public Task DeleteProductAsync(int id)
        {
            var dish = _dishes.FirstOrDefault(d => d.Id == id);
            if (dish != null)
            {
                _dishes.Remove(dish);
            }
            return Task.CompletedTask;
        }

        public Task<ResponseData<Dish>> CreateProductAsync(Dish product, IFormFile? formFile)
        {
            product.Id = _dishes.Max(d => d.Id) + 1;
            _dishes.Add(product);

            var result = new ResponseData<Dish>
            {
                Data = product
            };

            return Task.FromResult(result);
        }
    }
}